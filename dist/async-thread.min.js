
/*
 * -------------------------------------------------------
 * Project: AsyncTask
 * Version: 0.1.0
 *
 * Author:  Jalal Chaabane
 * Site:     
 * Contact: jalal.chaabane@gmail.com
 *
 *
 * Copyright (c) 2014 Jalal Chaabane
 * -------------------------------------------------------
 */

var Async={};Async.currentTask=null,Async.ThreadTask=function(task){var _listeners={},_self,processParameters=function(parameters){var str;return parameters.map(function(param){return"function"===param.type?(str=Array.prototype.join.call(["var fn=",param.data,";"],""),eval(str),fn):param.data})};return _self={emit:function(eventName){var msg={eventName:eventName,data:Array.prototype.slice.call(arguments,1,arguments.length)};postMessage(msg)},receiveMsg:function(msg){var event=_listeners[msg.eventName];"undefined"!=typeof event&&event.forEach(function(callback){callback.apply(callback,[msg].concat(msg.data))})},on:function(eventName,callback){var event=_listeners[eventName];"undefined"!=typeof event?event.push(callback):_listeners[eventName]=[callback]},execute:function(){var str,msg,result;str=Array.prototype.join.call(["var task_fn=",task.code,";"],""),eval(str),"undefined"!=typeof task.params&&(task.params=processParameters(task.params)),result=task_fn.apply(task_fn,[_self].concat(task.params)),msg={eventName:"onTaskDone",result:result},postMessage(msg)}}},onmessage=function(evt){var msg=evt.data;"postTask"===msg.eventName?(Async.currentTask=new Async.ThreadTask(evt.data),Async.currentTask.execute()):"importScript"===msg.eventName?importScripts(msg.file):null!==Async.currentTask&&Async.currentTask.receiveMsg(evt.data)};